# {{ istota_namespace | capitalize }} static site hosting — {{ istota_site_hostname }}
# Managed by Ansible — do not edit manually

# Redirect HTTP to HTTPS
server {
  listen [::]:80;
  listen 80;
  server_name {{ istota_site_hostname }};

  # include /etc/nginx/snippets/letsencrypt.conf;

  location / {
    return 301 https://$host$request_uri;
  }
}

server {
  listen [::]:443 ssl;
  listen 443 ssl;
  http2 on;

  server_name {{ istota_site_hostname }};

  # Default SSL certificates (comment out after Let's Encrypt enabled)
  include /etc/nginx/snippets/snakeoil.conf;

  # Uncomment block after Let's Encrypt cert is generated
  # ssl_certificate /etc/letsencrypt/live/{{ istota_site_hostname }}/fullchain.pem;
  # ssl_certificate_key /etc/letsencrypt/live/{{ istota_site_hostname }}/privkey.pem;
  # ssl_trusted_certificate /etc/letsencrypt/live/{{ istota_site_hostname }}/chain.pem;

  root {{ istota_home }}/html;

  charset utf-8;

  # Prevent search engine indexing by default
  add_header X-Robots-Tag "noindex, nofollow" always;

  # include /etc/nginx/snippets/letsencrypt.conf;

  # Per-user site locations
{% for user in _istota_site_users %}
  location /~{{ user.key }} {
    alias {{ istota_nextcloud_mount_path }}/Users/{{ user.key }}/{{ istota_namespace }}/html;
    autoindex on;
    # To prevent issues with nginx serving from rclone fuse mount
    sendfile off;
    open_file_cache off;
{% for route in user.value.site_private_routes | default([]) %}

    location /~{{ user.key }}{{ route }} {
      alias {{ istota_nextcloud_mount_path }}/Users/{{ user.key }}/{{ istota_namespace }}/html{{ route }};
      # Restrict to private/local networks only
      allow 10.0.0.0/8;
      allow 172.16.0.0/12;
      allow 192.168.0.0/16;
      deny all;
      autoindex on;
    }
{% endfor %}
  }

{% endfor %}
}
